<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edge Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #0f172a; color: #e2e8f0; }
    header { padding: 16px 24px; background: #111827; display: flex; align-items: center; gap: 16px; }
    h1 { margin: 0; font-size: 20px; }
    .container { display: grid; grid-template-columns: 360px 1fr; gap: 16px; padding: 16px; }
    .panel { background: #111827; border-radius: 8px; padding: 12px; }
    input { width: 100%; padding: 8px; background: #0b1220; border: 1px solid #1f2937; color: #e2e8f0; border-radius: 6px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 6px 4px; font-size: 13px; border-bottom: 1px solid #1f2937; }
    .status-online { color: #22c55e; font-weight: 600; }
    .status-offline { color: #ef4444; font-weight: 600; }
    .device-row { cursor: pointer; }
    .badge { background: #1f2937; border-radius: 999px; padding: 2px 8px; font-size: 12px; }
    .grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }
    .card { background: #0b1220; border-radius: 8px; padding: 10px; }
    .value { font-size: 18px; font-weight: 600; }
    .muted { color: #94a3b8; font-size: 12px; }
    .sparkline { width: 100%; height: 40px; }
    .footer { padding: 0 16px 16px 16px; }
    a { color: #38bdf8; text-decoration: none; }
  </style>
</head>
<body>
  <header>
    <h1>Edge Dashboard</h1>
    <span class="badge" id="deviceCount">0 devices</span>
    <span class="badge" id="lastUpdate">-</span>
  </header>
  <div class="container">
    <div class="panel">
      <input id="search" placeholder="Søg deviceId..." />
      <table>
        <thead>
          <tr>
            <th>Device</th>
            <th>Status</th>
            <th>Sidst set</th>
          </tr>
        </thead>
        <tbody id="deviceList"></tbody>
      </table>
    </div>
    <div class="panel">
      <div id="deviceDetail">
        <p class="muted">Vælg en device for detaljer.</p>
      </div>
    </div>
  </div>
  <div class="footer">
    <a id="csvLink" href="/api/csv" target="_blank">Download dagens CSV</a>
  </div>

  <script>
    const state = {
      devices: [],
      selected: null
    };

    function formatTime(ms) {
      if (!ms) return '-';
      const d = new Date(ms);
      return d.toLocaleString();
    }

    function statusClass(status) {
      if (status === 'online') return 'status-online';
      if (status === 'offline') return 'status-offline';
      return '';
    }

    function buildSparkline(points) {
      if (!points || points.length < 2) return '';
      const values = points.map(p => parseFloat(p[1])).filter(v => !Number.isNaN(v));
      if (values.length < 2) return '';
      const min = Math.min(...values);
      const max = Math.max(...values);
      const span = max - min || 1;
      const w = 200;
      const h = 40;
      const step = w / (values.length - 1);
      const coords = values.map((v, i) => {
        const x = i * step;
        const y = h - ((v - min) / span) * h;
        return `${x},${y}`;
      }).join(' ');
      return `<svg class="sparkline" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none"><polyline fill="none" stroke="#38bdf8" stroke-width="2" points="${coords}" /></svg>`;
    }

    function renderDeviceList() {
      const filter = document.getElementById('search').value.trim().toLowerCase();
      const tbody = document.getElementById('deviceList');
      tbody.innerHTML = '';

      const filtered = state.devices.filter(d => d.device.toLowerCase().includes(filter));
      filtered.forEach(device => {
        const tr = document.createElement('tr');
        tr.className = 'device-row';
        tr.innerHTML = `
          <td>${device.device}</td>
          <td class="${statusClass(device.status)}">${device.status || 'unknown'}</td>
          <td>${formatTime(device.last_seen_unix_ms)}</td>
        `;
        tr.onclick = () => {
          state.selected = device.device;
          renderDeviceDetail();
        };
        tbody.appendChild(tr);
      });

      document.getElementById('deviceCount').textContent = `${filtered.length} devices`;
      document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
    }

    async function fetchDeviceDetail(deviceId) {
      const res = await fetch(`/api/device/${deviceId}`);
      if (!res.ok) return null;
      return await res.json();
    }

    async function renderDeviceDetail() {
      if (!state.selected) return;
      const detail = await fetchDeviceDetail(state.selected);
      const container = document.getElementById('deviceDetail');
      if (!detail) {
        container.innerHTML = '<p class="muted">Ikke fundet.</p>';
        return;
      }

      const latest = detail.latest || {};
      const cards = Object.entries(latest).map(([datatype, data]) => {
        const history = detail.history ? detail.history[datatype] : [];
        return `
          <div class="card">
            <div class="muted">${datatype}</div>
            <div class="value">${data.value ?? '-'}</div>
            <div class="muted">${formatTime(data.ts_unix_ms)}</div>
            ${buildSparkline(history)}
          </div>
        `;
      }).join('');

      container.innerHTML = `
        <h2>${detail.device}</h2>
        <p class="muted">Status: <span class="${statusClass(detail.status)}">${detail.status}</span></p>
        <p class="muted">Sidst set: ${formatTime(detail.last_seen_unix_ms)}</p>
        <div class="grid">${cards || '<p class="muted">Ingen data.</p>'}</div>
      `;
    }

    async function refresh() {
      const res = await fetch('/api/devices');
      state.devices = await res.json();
      renderDeviceList();
      if (state.selected) {
        renderDeviceDetail();
      }
    }

    document.getElementById('search').addEventListener('input', renderDeviceList);

    refresh();
    setInterval(refresh, 5000);
  </script>
</body>
</html>
